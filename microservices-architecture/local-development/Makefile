# ğŸš€ LibreChat Microservices - Development Makefile
# Comenzi simple pentru development pe laptop

.PHONY: help setup start stop restart logs clean build test

# Default target
help: ## AratÄƒ acest help message
	@echo "ğŸš€ LibreChat Microservices - Development Commands"
	@echo "=================================================="
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# Setup È™i configurare
setup: ## Setup complet pentru laptop development
	@echo "ğŸ”§ Setting up LibreChat pentru laptop development..."
	@chmod +x setup-laptop.sh
	@./setup-laptop.sh

setup-minimal: ## Setup minimal pentru laptops cu RAM limitat (4GB)
	@echo "ğŸ’» Setting up minimal LibreChat pentru low-resource laptops..."
	@export COMPOSE_FILE=docker-compose.minimal.yml && chmod +x setup-laptop.sh && ./setup-laptop.sh

# Service management
start: ## Start all microservices
	@echo "ğŸš€ Starting LibreChat microservices..."
	@source .env.local && docker-compose -f $${COMPOSE_FILE:-docker-compose.dev.yml} up -d
	@echo "âœ… Services started! Check 'make status' pentru details."

start-minimal: ## Start minimal setup (4GB RAM)
	@echo "ğŸ’» Starting minimal LibreChat setup..."
	@docker-compose -f docker-compose.minimal.yml up -d
	@echo "âœ… Minimal services started!"

stop: ## Stop all microservices
	@echo "ğŸ›‘ Stopping LibreChat microservices..."
	@source .env.local && docker-compose -f $${COMPOSE_FILE:-docker-compose.dev.yml} down
	@echo "âœ… Services stopped!"

restart: ## Restart all microservices
	@echo "ğŸ”„ Restarting LibreChat microservices..."
	@make stop
	@sleep 5
	@make start

restart-service: ## Restart specific service (usage: make restart-service SERVICE=identity-service)
	@echo "ğŸ”„ Restarting $(SERVICE)..."
	@source .env.local && docker-compose -f $${COMPOSE_FILE:-docker-compose.dev.yml} restart $(SERVICE)

# Monitoring È™i debugging
status: ## Show services status È™i URLs
	@echo "ğŸ“Š LibreChat Services Status:"
	@echo "=============================="
	@source .env.local && docker-compose -f $${COMPOSE_FILE:-docker-compose.dev.yml} ps
	@echo ""
	@echo "ğŸŒ Access URLs:"
	@echo "  API Gateway:     http://localhost"
	@echo "  Keycloak Admin:  http://localhost:8080 (admin/admin123)"
	@echo "  Grafana:         http://localhost:3000 (admin/admin123)"
	@echo "  Prometheus:      http://localhost:9090"
	@echo "  Jaeger:          http://localhost:16686"
	@echo "  Kafka UI:        http://localhost:8082"
	@echo "  Redis UI:        http://localhost:8083"

logs: ## View all services logs
	@source .env.local && docker-compose -f $${COMPOSE_FILE:-docker-compose.dev.yml} logs -f

logs-service: ## View specific service logs (usage: make logs-service SERVICE=identity-service)
	@source .env.local && docker-compose -f $${COMPOSE_FILE:-docker-compose.dev.yml} logs -f $(SERVICE)

stats: ## Show Docker resource usage
	@echo "ğŸ“Š Docker Resource Usage:"
	@docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}"

# Development
build: ## Build all service images
	@echo "ğŸ”¨ Building LibreChat service images..."
	@source .env.local && docker-compose -f $${COMPOSE_FILE:-docker-compose.dev.yml} build --parallel

build-service: ## Build specific service (usage: make build-service SERVICE=identity-service)
	@echo "ğŸ”¨ Building $(SERVICE)..."
	@source .env.local && docker-compose -f $${COMPOSE_FILE:-docker-compose.dev.yml} build $(SERVICE)

dev-identity: ## Start identity service Ã®n development mode cu hot reload
	@echo "ğŸ”¥ Starting Identity Service Ã®n hot reload mode..."
	@cd ../services/identity-service && dotnet watch run --urls http://localhost:5001

dev-ai-gateway: ## Start AI gateway Ã®n development mode cu hot reload
	@echo "ğŸ”¥ Starting AI Gateway Service Ã®n hot reload mode..."
	@cd ../services/ai-gateway-service && air

dev-conversation: ## Start conversation service Ã®n development mode cu hot reload
	@echo "ğŸ”¥ Starting Conversation Service Ã®n hot reload mode..."
	@cd ../services/conversation-service && dotnet watch run --urls http://localhost:5002

# Testing
test: ## Run all tests
	@echo "ğŸ§ª Running all tests..."
	@make test-dotnet
	@make test-go

test-dotnet: ## Run .NET service tests
	@echo "ğŸ§ª Running .NET tests..."
	@cd ../services/identity-service && dotnet test
	@cd ../services/conversation-service && dotnet test

test-go: ## Run Go service tests
	@echo "ğŸ§ª Running Go tests..."
	@cd ../services/ai-gateway-service && go test ./...
	@cd ../services/search-service && go test ./...

test-integration: ## Run integration tests
	@echo "ğŸ§ª Running integration tests..."
	@cd ../tests && npm test

load-test: ## Run load tests cu k6
	@echo "âš¡ Running load tests..."
	@k6 run ../tests/load-tests/identity-service.js
	@k6 run ../tests/load-tests/ai-gateway.js

# Database management
db-migrate: ## Run database migrations
	@echo "ğŸ—„ï¸ Running database migrations..."
	@cd ../services/identity-service && dotnet ef database update
	@cd ../services/conversation-service && dotnet ef database update

db-reset: ## Reset all databases (âš ï¸  destructive!)
	@echo "âš ï¸  Resetting all databases..."
	@read -p "Are you sure? This will delete all data! (y/N): " confirm && [ "$$confirm" = "y" ]
	@source .env.local && docker-compose -f $${COMPOSE_FILE:-docker-compose.dev.yml} down -v
	@make start

db-backup: ## Backup databases
	@echo "ğŸ’¾ Creating database backup..."
	@mkdir -p ./backups
	@docker exec librechat-postgres pg_dump -U librechat librechat > ./backups/librechat-$(shell date +%Y%m%d-%H%M%S).sql
	@echo "âœ… Backup created Ã®n ./backups/"

db-restore: ## Restore database from backup (usage: make db-restore BACKUP=filename.sql)
	@echo "ğŸ“¥ Restoring database from $(BACKUP)..."
	@docker exec -i librechat-postgres psql -U librechat -d librechat < ./backups/$(BACKUP)

# Cleanup È™i maintenance
clean: ## Clean Docker resources (images, volumes, networks)
	@echo "ğŸ§¹ Cleaning Docker resources..."
	@source .env.local && docker-compose -f $${COMPOSE_FILE:-docker-compose.dev.yml} down -v
	@docker system prune -f
	@docker volume prune -f
	@echo "âœ… Cleanup complete!"

clean-logs: ## Clean service logs
	@echo "ğŸ§¹ Cleaning service logs..."
	@rm -rf logs/*
	@mkdir -p logs/{identity,conversation,ai-gateway,search}
	@echo "âœ… Logs cleaned!"

reset: ## Complete reset (âš ï¸  destructive!)
	@echo "âš ï¸  Complete environment reset..."
	@read -p "This will delete ALL data and containers! Continue? (y/N): " confirm && [ "$$confirm" = "y" ]
	@make clean
	@docker image prune -a -f
	@rm -rf data/*
	@echo "âœ… Complete reset done! Run 'make setup' to reinitialize."

# Utility commands
shell-postgres: ## Open PostgreSQL shell
	@docker exec -it librechat-postgres psql -U librechat -d librechat

shell-redis: ## Open Redis shell
	@docker exec -it librechat-redis redis-cli

shell-service: ## Open shell Ã®n service container (usage: make shell-service SERVICE=identity-service)
	@docker exec -it librechat-$(SERVICE) /bin/bash

# Monitoring È™i debugging
monitor: ## Open monitoring dashboard Ã®n browser
	@echo "ğŸ“Š Opening monitoring dashboards..."
	@open http://localhost:3000  # Grafana
	@open http://localhost:9090  # Prometheus
	@open http://localhost:16686 # Jaeger

debug-service: ## Debug specific service (usage: make debug-service SERVICE=identity-service)
	@echo "ğŸ› Debugging $(SERVICE)..."
	@source .env.local && docker-compose -f $${COMPOSE_FILE:-docker-compose.dev.yml} logs -f $(SERVICE)

health-check: ## Check health of all services
	@echo "ğŸ¥ Health checking all services..."
	@curl -s http://localhost/health && echo "âœ… API Gateway: OK" || echo "âŒ API Gateway: FAIL"
	@curl -s http://localhost:5001/health && echo "âœ… Identity Service: OK" || echo "âŒ Identity Service: FAIL"
	@curl -s http://localhost:5002/health && echo "âœ… Conversation Service: OK" || echo "âŒ Conversation Service: FAIL"
	@curl -s http://localhost:8080/health && echo "âœ… AI Gateway: OK" || echo "âŒ AI Gateway: FAIL"
	@curl -s http://localhost:8081/health && echo "âœ… Search Service: OK" || echo "âŒ Search Service: FAIL"

# Performance È™i optimization
optimize-laptop: ## Optimize settings pentru laptop performance
	@echo "âš¡ Optimizing pentru laptop performance..."
	@docker system df
	@echo "ğŸ’¡ Consider running 'make clean' dacÄƒ disk space este low"
	@echo "ğŸ’¡ Use 'make start-minimal' dacÄƒ RAM usage este high"

benchmark: ## Run performance benchmarks
	@echo "âš¡ Running performance benchmarks..."
	@echo "Testing API Gateway throughput..."
	@ab -n 1000 -c 10 http://localhost/health
	@echo "Testing Identity Service..."
	@ab -n 500 -c 5 http://localhost:5001/health

# Documentation
docs: ## Generate È™i open documentation
	@echo "ğŸ“š Generating documentation..."
	@echo "Opening architecture documentation..."
	@open ../GENIUS-ARCHITECTURE.md

# Quick commands pentru daily development
daily: ## Daily development startup routine
	@echo "â˜€ï¸  Starting daily development routine..."
	@make start
	@sleep 30
	@make health-check
	@make status
	@echo "ğŸ‰ Ready pentru development!"

evening: ## Evening cleanup routine
	@echo "ğŸŒ™ Evening cleanup routine..."
	@make stop
	@make clean-logs
	@echo "ğŸ˜´ Good night! Environment cleaned for tomorrow."

# Emergency commands
emergency-stop: ## Emergency stop all containers
	@echo "ğŸš¨ Emergency stop - killing all LibreChat containers..."
	@docker kill $$(docker ps -q --filter "name=librechat-*") 2>/dev/null || true
	@echo "âœ… Emergency stop complete!"

emergency-reset: ## Emergency reset fÄƒrÄƒ confirmation
	@echo "ğŸš¨ Emergency reset..."
	@make emergency-stop
	@docker system prune -a -f
	@docker volume rm $$(docker volume ls -q --filter "name=librechat*") 2>/dev/null || true
	@echo "âœ… Emergency reset complete!"

# Development helpers
generate-proto: ## Generate protobuf code pentru all services
	@echo "ğŸ”§ Generating protobuf code..."
	@cd ../shared/contracts && protoc --go_out=. --go-grpc_out=. *.proto
	@cd ../services/identity-service && dotnet build # Regenerate C# code
	@echo "âœ… Protobuf code generated!"

update-deps: ## Update all service dependencies
	@echo "ğŸ“¦ Updating dependencies..."
	@cd ../services/identity-service && dotnet restore
	@cd ../services/conversation-service && dotnet restore
	@cd ../services/ai-gateway-service && go mod tidy
	@cd ../services/search-service && go mod tidy
	@echo "âœ… Dependencies updated!"

# Quick development workflow
quick-start: setup start ## Quick setup È™i start (new laptops)
quick-restart: stop start ## Quick restart all services
quick-test: build test ## Quick build È™i test all services

# Resource monitoring
memory-usage: ## Show memory usage per service
	@echo "ğŸ’¾ Memory Usage per Service:"
	@docker stats --no-stream --format "table {{.Container}}\t{{.MemUsage}}\t{{.MemPerc}}" | grep librechat

cpu-usage: ## Show CPU usage per service  
	@echo "ğŸ–¥ï¸  CPU Usage per Service:"
	@docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}" | grep librechat

disk-usage: ## Show disk usage
	@echo "ğŸ’¿ Disk Usage:"
	@docker system df
	@echo ""
	@echo "ğŸ“Š Volume Usage:"
	@docker volume ls --format "table {{.Name}}\t{{.Driver}}" | grep librechat